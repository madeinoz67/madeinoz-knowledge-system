#!/bin/bash
# Integration tests for start.sh environment variable generation
# Tests the actual shell script behavior

# Test directory
TEST_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(cd "$TEST_DIR/../.." && pwd)"
SERVER_DIR="$PROJECT_DIR/src/server"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Test counters
TESTS_RUN=0
TESTS_PASSED=0
TESTS_FAILED=0

# Test results
FAILURES=()

# Helper functions
print_header() {
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "  $1"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
}

print_test() {
    echo -n "Testing: $1 ... "
}

print_pass() {
    echo -e "${GREEN}PASS${NC}"
    ((TESTS_PASSED++))
    ((TESTS_RUN++))
}

print_fail() {
    echo -e "${RED}FAIL${NC}"
    echo "  Reason: $1"
    FAILURES+=("$2: $1")
    ((TESTS_FAILED++))
    ((TESTS_RUN++))
}

print_skip() {
    echo -e "${YELLOW}SKIP${NC}"
    echo "  Reason: $1"
}

# Setup test environment
setup_test_env() {
    local test_name="$1"
    TEST_ENV_DIR=$(mktemp -d)
    export TEST_ENV_DIR

    # Create test .env file
    cat > "$TEST_ENV_DIR/.env" << EOF
# Test environment for $test_name
MADEINOZ_KNOWLEDGE_LLM_PROVIDER=openai
MADEINOZ_KNOWLEDGE_MODEL_NAME=google/gemini-2.0-flash-001
MADEINOZ_KNOWLEDGE_OPENAI_API_KEY=sk-test-key-12345
MADEINOZ_KNOWLEDGE_OPENAI_BASE_URL=https://openrouter.ai/api/v1
MADEINOZ_KNOWLEDGE_EMBEDDER_PROVIDER=ollama
MADEINOZ_KNOWLEDGE_EMBEDDER_MODEL=mxbai-embed-large
MADEINOZ_KNOWLEDGE_EMBEDDER_DIMENSIONS=1024
MADEINOZ_KNOWLEDGE_OLLAMA_BASE_URL=http://host.containers.internal:11434
MADEINOZ_KNOWLEDGE_GROUP_ID=test-group
MADEINOZ_KNOWLEDGE_SEMAPHORE_LIMIT=15
MADEINOZ_KNOWLEDGE_GRAPHITI_TELEMETRY_ENABLED=false
GRAPHITI_SEARCH_ALL_GROUPS=true
MADEINOZ_KNOWLEDGE_DATABASE_TYPE=neo4j
NEO4J_URI=bolt://neo4j:7687
NEO4J_USER=neo4j
NEO4J_PASSWORD=testpassword
EOF

    # Create mock start.sh script that only generates .env file
    cat > "$TEST_ENV_DIR/start.sh" << 'SCRIPT'
#!/bin/bash
# Simplified start.sh for testing - only generates .env file

ENV_FILE="${1:-$TEST_ENV_DIR/.env}"
GENERATED_ENV="/tmp/madeinoz-knowledge-test.env"

# Load environment variables
if [ -f "$ENV_FILE" ]; then
    set -a
    source "$ENV_FILE"
    set +a
fi

# Determine database type
DATABASE_TYPE="${MADEINOZ_KNOWLEDGE_DATABASE_TYPE:-neo4j}"

# Generate mapped .env file
cat > "$GENERATED_ENV" << EOF
# LLM Provider Configuration
LLM_PROVIDER=${MADEINOZ_KNOWLEDGE_LLM_PROVIDER:-openai}
MODEL_NAME=${MADEINOZ_KNOWLEDGE_MODEL_NAME:-openai/gpt-4o-mini}
TEMPERATURE=${MADEINOZ_KNOWLEDGE_TEMPERATURE:-}
MAX_TOKENS=${MADEINOZ_KNOWLEDGE_MAX_TOKENS:-}

# OpenAI/OpenRouter API Configuration
OPENAI_API_KEY=${MADEINOZ_KNOWLEDGE_OPENAI_API_KEY:-}
OPENAI_BASE_URL=${MADEINOZ_KNOWLEDGE_OPENAI_BASE_URL:-https://openrouter.ai/api/v1}
OPENAI_ORGANIZATION_ID=${MADEINOZ_KNOWLEDGE_OPENAI_ORGANIZATION_ID:-}

# Embedder Configuration
EMBEDDER_PROVIDER=${MADEINOZ_KNOWLEDGE_EMBEDDER_PROVIDER:-ollama}
EMBEDDER_MODEL=${MADEINOZ_KNOWLEDGE_EMBEDDER_MODEL:-mxbai-embed-large}
EMBEDDER_DIMENSIONS=${MADEINOZ_KNOWLEDGE_EMBEDDER_DIMENSIONS:-1024}
EMBEDDER_BASE_URL=${MADEINOZ_KNOWLEDGE_EMBEDDER_BASE_URL:-}

# Ollama Configuration
OLLAMA_BASE_URL=${MADEINOZ_KNOWLEDGE_OLLAMA_BASE_URL:-http://host.containers.internal:11434}

# Graphiti Configuration
GRAPHITI_GROUP_ID=${MADEINOZ_KNOWLEDGE_GROUP_ID:-main}
EPISODE_ID_PREFIX=${MADEINOZ_KNOWLEDGE_EPISODE_ID_PREFIX:-}
USER_ID=${MADEINOZ_KNOWLEDGE_USER_ID:-}
SEMAPHORE_LIMIT=${MADEINOZ_KNOWLEDGE_SEMAPHORE_LIMIT:-10}
GRAPHITI_TELEMETRY_ENABLED=${MADEINOZ_KNOWLEDGE_GRAPHITI_TELEMETRY_ENABLED:-false}
GRAPHITI_SEARCH_ALL_GROUPS=${GRAPHITI_SEARCH_ALL_GROUPS:-false}
DATABASE_TYPE=${DATABASE_TYPE}

# Neo4j Configuration
NEO4J_URI=${NEO4J_URI:-bolt://neo4j:7687}
NEO4J_USER=${NEO4J_USER:-neo4j}
NEO4J_PASSWORD=${NEO4J_PASSWORD:-madeinozknowledge}
NEO4J_DATABASE=${NEO4J_DATABASE:-neo4j}
USE_PARALLEL_RUNTIME=${USE_PARALLEL_RUNTIME:-}

# FalkorDB Configuration
FALKORDB_HOST=${MADEINOZ_KNOWLEDGE_FALKORDB_HOST:-falkordb}
FALKORDB_PORT=${MADEINOZ_KNOWLEDGE_FALKORDB_PORT:-6379}
FALKORDB_PASSWORD=${MADEINOZ_KNOWLEDGE_FALKORDB_PASSWORD:-}
FALKORDB_URI=${FALKORDB_URI:-}
EOF

echo "$GENERATED_ENV"
SCRIPT

    chmod +x "$TEST_ENV_DIR/start.sh"
}

# Cleanup test environment
cleanup_test_env() {
    if [ -n "$TEST_ENV_DIR" ] && [ -d "$TEST_ENV_DIR" ]; then
        rm -rf "$TEST_ENV_DIR"
    fi
    if [ -f "/tmp/madeinoz-knowledge-test.env" ]; then
        rm -f "/tmp/madeinoz-knowledge-test.env"
    fi
}

# Assert functions
assert_env_var() {
    local file="$1"
    local key="$2"
    local expected="$3"

    if [ ! -f "$file" ]; then
        echo "  Error: File $file does not exist"
        return 1
    fi

    local actual
    actual=$(grep "^${key}=" "$file" | cut -d'=' -f2-)

    if [ "$actual" != "$expected" ]; then
        echo "  Error: $key"
        echo "    Expected: $expected"
        echo "    Actual:   $actual"
        return 1
    fi

    return 0
}

assert_env_var_exists() {
    local file="$1"
    local key="$2"

    if [ ! -f "$file" ]; then
        echo "  Error: File $file does not exist"
        return 1
    fi

    if ! grep -q "^${key}=" "$file"; then
        echo "  Error: Variable $key not found in $file"
        return 1
    fi

    return 0
}

assert_env_var_not_exists() {
    local file="$1"
    local key="$2"

    if [ ! -f "$file" ]; then
        echo "  Error: File $file does not exist"
        return 1
    fi

    if grep -q "^${key}=" "$file"; then
        echo "  Error: Variable $key should not exist in $file"
        return 1
    fi

    return 0
}

# ============================================================================
# Tests
# ============================================================================

print_header "Environment Variable Generation Tests"

# Test 1: LLM Provider Configuration
print_test "LLM_PROVIDER mapping"
setup_test_env "llm_provider"
GENERATED_ENV=$("$TEST_ENV_DIR/start.sh" "$TEST_ENV_DIR/.env")
if assert_env_var "$GENERATED_ENV" "LLM_PROVIDER" "openai"; then
    print_pass
else
    print_fail "LLM_PROVIDER mapping failed" "test_llm_provider"
fi
cleanup_test_env

# Test 2: MODEL_NAME mapping
print_test "MODEL_NAME mapping"
setup_test_env "model_name"
GENERATED_ENV=$("$TEST_ENV_DIR/start.sh" "$TEST_ENV_DIR/.env")
if assert_env_var "$GENERATED_ENV" "MODEL_NAME" "google/gemini-2.0-flash-001"; then
    print_pass
else
    print_fail "MODEL_NAME mapping failed" "test_model_name"
fi
cleanup_test_env

# Test 3: OPENAI_API_KEY mapping
print_test "OPENAI_API_KEY mapping"
setup_test_env "openai_api_key"
GENERATED_ENV=$("$TEST_ENV_DIR/start.sh" "$TEST_ENV_DIR/.env")
if assert_env_var "$GENERATED_ENV" "OPENAI_API_KEY" "sk-test-key-12345"; then
    print_pass
else
    print_fail "OPENAI_API_KEY mapping failed" "test_openai_api_key"
fi
cleanup_test_env

# Test 4: OPENAI_BASE_URL mapping
print_test "OPENAI_BASE_URL mapping"
setup_test_env "openai_base_url"
GENERATED_ENV=$("$TEST_ENV_DIR/start.sh" "$TEST_ENV_DIR/.env")
if assert_env_var "$GENERATED_ENV" "OPENAI_BASE_URL" "https://openrouter.ai/api/v1"; then
    print_pass
else
    print_fail "OPENAI_BASE_URL mapping failed" "test_openai_base_url"
fi
cleanup_test_env

# Test 5: EMBEDDER_PROVIDER mapping
print_test "EMBEDDER_PROVIDER mapping"
setup_test_env "embedder_provider"
GENERATED_ENV=$("$TEST_ENV_DIR/start.sh" "$TEST_ENV_DIR/.env")
if assert_env_var "$GENERATED_ENV" "EMBEDDER_PROVIDER" "ollama"; then
    print_pass
else
    print_fail "EMBEDDER_PROVIDER mapping failed" "test_embedder_provider"
fi
cleanup_test_env

# Test 6: OLLAMA_BASE_URL mapping
print_test "OLLAMA_BASE_URL mapping"
setup_test_env "ollama_base_url"
GENERATED_ENV=$("$TEST_ENV_DIR/start.sh" "$TEST_ENV_DIR/.env")
if assert_env_var "$GENERATED_ENV" "OLLAMA_BASE_URL" "http://host.containers.internal:11434"; then
    print_pass
else
    print_fail "OLLAMA_BASE_URL mapping failed" "test_ollama_base_url"
fi
cleanup_test_env

# Test 7: GRAPHITI_GROUP_ID mapping
print_test "GRAPHITI_GROUP_ID mapping"
setup_test_env "graphiti_group_id"
GENERATED_ENV=$("$TEST_ENV_DIR/start.sh" "$TEST_ENV_DIR/.env")
if assert_env_var "$GENERATED_ENV" "GRAPHITI_GROUP_ID" "test-group"; then
    print_pass
else
    print_fail "GRAPHITI_GROUP_ID mapping failed" "test_graphiti_group_id"
fi
cleanup_test_env

# Test 8: SEMAPHORE_LIMIT mapping
print_test "SEMAPHORE_LIMIT mapping"
setup_test_env "semaphore_limit"
GENERATED_ENV=$("$TEST_ENV_DIR/start.sh" "$TEST_ENV_DIR/.env")
if assert_env_var "$GENERATED_ENV" "SEMAPHORE_LIMIT" "15"; then
    print_pass
else
    print_fail "SEMAPHORE_LIMIT mapping failed" "test_semaphore_limit"
fi
cleanup_test_env

# Test 9: GRAPHITI_SEARCH_ALL_GROUPS (new variable name)
print_test "GRAPHITI_SEARCH_ALL_GROUPS mapping (renamed variable)"
setup_test_env "graphiti_search_all_groups"
GENERATED_ENV=$("$TEST_ENV_DIR/start.sh" "$TEST_ENV_DIR/.env")
if assert_env_var "$GENERATED_ENV" "GRAPHITI_SEARCH_ALL_GROUPS" "true"; then
    print_pass
else
    print_fail "GRAPHITI_SEARCH_ALL_GROUPS mapping failed" "test_graphiti_search_all_groups"
fi
cleanup_test_env

# Test 10: Verify old variable name is NOT in generated file
print_test "Old variable name NOT in generated env"
setup_test_env "old_variable_check"
GENERATED_ENV=$("$TEST_ENV_DIR/start.sh" "$TEST_ENV_DIR/.env")
if assert_env_var_not_exists "$GENERATED_ENV" "MADEINOZ_KNOWLEDGE_SEARCH_ALL_GROUPS"; then
    print_pass
else
    print_fail "Old variable name should not exist" "test_old_variable"
fi
cleanup_test_env

# Test 11: DATABASE_TYPE mapping
print_test "DATABASE_TYPE mapping"
setup_test_env "database_type"
GENERATED_ENV=$("$TEST_ENV_DIR/start.sh" "$TEST_ENV_DIR/.env")
if assert_env_var "$GENERATED_ENV" "DATABASE_TYPE" "neo4j"; then
    print_pass
else
    print_fail "DATABASE_TYPE mapping failed" "test_database_type"
fi
cleanup_test_env

# Test 12: NEO4J_URI pass-through (unprefixed)
print_test "NEO4J_URI pass-through (unprefixed)"
setup_test_env "neo4j_uri"
GENERATED_ENV=$("$TEST_ENV_DIR/start.sh" "$TEST_ENV_DIR/.env")
if assert_env_var "$GENERATED_ENV" "NEO4J_URI" "bolt://neo4j:7687"; then
    print_pass
else
    print_fail "NEO4J_URI pass-through failed" "test_neo4j_uri"
fi
cleanup_test_env

# Test 13: NEO4J_PASSWORD pass-through
print_test "NEO4J_PASSWORD pass-through"
setup_test_env "neo4j_password"
GENERATED_ENV=$("$TEST_ENV_DIR/start.sh" "$TEST_ENV_DIR/.env")
if assert_env_var "$GENERATED_ENV" "NEO4J_PASSWORD" "testpassword"; then
    print_pass
else
    print_fail "NEO4J_PASSWORD pass-through failed" "test_neo4j_password"
fi
cleanup_test_env

# Test 14: Default values when variables not set
print_test "Default values are applied"
cat > /tmp/test_defaults.env << EOF
MADEINOZ_KNOWLEDGE_DATABASE_TYPE=falkordb
EOF

# Create a temporary directory with the start.sh script
TEST_ENV_DIR=$(mktemp -d)
export TEST_ENV_DIR

# Create the start.sh script in the test directory
cat > "$TEST_ENV_DIR/start.sh" << 'SCRIPT'
#!/bin/bash
# Simplified start.sh for testing - only generates .env file

ENV_FILE="${1:-$TEST_ENV_DIR/.env}"
GENERATED_ENV="/tmp/madeinoz-knowledge-test.env"

# Load environment variables
if [ -f "$ENV_FILE" ]; then
    set -a
    source "$ENV_FILE"
    set +a
fi

# Determine database type
DATABASE_TYPE="${MADEINOZ_KNOWLEDGE_DATABASE_TYPE:-neo4j}"

# Generate mapped .env file
cat > "$GENERATED_ENV" << EOF
# LLM Provider Configuration
LLM_PROVIDER=${MADEINOZ_KNOWLEDGE_LLM_PROVIDER:-openai}
MODEL_NAME=${MADEINOZ_KNOWLEDGE_MODEL_NAME:-openai/gpt-4o-mini}
TEMPERATURE=${MADEINOZ_KNOWLEDGE_TEMPERATURE:-}
MAX_TOKENS=${MADEINOZ_KNOWLEDGE_MAX_TOKENS:-}

# OpenAI/OpenRouter API Configuration
OPENAI_API_KEY=${MADEINOZ_KNOWLEDGE_OPENAI_API_KEY:-}
OPENAI_BASE_URL=${MADEINOZ_KNOWLEDGE_OPENAI_BASE_URL:-https://openrouter.ai/api/v1}
OPENAI_ORGANIZATION_ID=${MADEINOZ_KNOWLEDGE_OPENAI_ORGANIZATION_ID:-}

# Embedder Configuration
EMBEDDER_PROVIDER=${MADEINOZ_KNOWLEDGE_EMBEDDER_PROVIDER:-ollama}
EMBEDDER_MODEL=${MADEINOZ_KNOWLEDGE_EMBEDDER_MODEL:-mxbai-embed-large}
EMBEDDER_DIMENSIONS=${MADEINOZ_KNOWLEDGE_EMBEDDER_DIMENSIONS:-1024}
EMBEDDER_BASE_URL=${MADEINOZ_KNOWLEDGE_EMBEDDER_BASE_URL:-}

# Ollama Configuration
OLLAMA_BASE_URL=${MADEINOZ_KNOWLEDGE_OLLAMA_BASE_URL:-http://host.containers.internal:11434}

# Graphiti Configuration
GRAPHITI_GROUP_ID=${MADEINOZ_KNOWLEDGE_GROUP_ID:-main}
EPISODE_ID_PREFIX=${MADEINOZ_KNOWLEDGE_EPISODE_ID_PREFIX:-}
USER_ID=${MADEINOZ_KNOWLEDGE_USER_ID:-}
SEMAPHORE_LIMIT=${MADEINOZ_KNOWLEDGE_SEMAPHORE_LIMIT:-10}
GRAPHITI_TELEMETRY_ENABLED=${MADEINOZ_KNOWLEDGE_GRAPHITI_TELEMETRY_ENABLED:-false}
GRAPHITI_SEARCH_ALL_GROUPS=${GRAPHITI_SEARCH_ALL_GROUPS:-false}
DATABASE_TYPE=${DATABASE_TYPE}

# Neo4j Configuration
NEO4J_URI=${NEO4J_URI:-bolt://neo4j:7687}
NEO4J_USER=${NEO4J_USER:-neo4j}
NEO4J_PASSWORD=${NEO4J_PASSWORD:-madeinozknowledge}
NEO4J_DATABASE=${NEO4J_DATABASE:-neo4j}
USE_PARALLEL_RUNTIME=${USE_PARALLEL_RUNTIME:-}

# FalkorDB Configuration
FALKORDB_HOST=${MADEINOZ_KNOWLEDGE_FALKORDB_HOST:-falkordb}
FALKORDB_PORT=${MADEINOZ_KNOWLEDGE_FALKORDB_PORT:-6379}
FALKORDB_PASSWORD=${MADEINOZ_KNOWLEDGE_FALKORDB_PASSWORD:-}
FALKORDB_URI=${FALKORDB_URI:-}
EOF

echo "$GENERATED_ENV"
SCRIPT

chmod +x "$TEST_ENV_DIR/start.sh"

GENERATED_ENV=$("$TEST_ENV_DIR/start.sh" /tmp/test_defaults.env)

if assert_env_var "$GENERATED_ENV" "LLM_PROVIDER" "openai" && \
   assert_env_var "$GENERATED_ENV" "MODEL_NAME" "openai/gpt-4o-mini" && \
   assert_env_var "$GENERATED_ENV" "EMBEDDER_PROVIDER" "ollama" && \
   assert_env_var "$GENERATED_ENV" "SEMAPHORE_LIMIT" "10" && \
   assert_env_var "$GENERATED_ENV" "GRAPHITI_GROUP_ID" "main"; then
    print_pass
else
    print_fail "Default values not correctly applied" "test_defaults"
fi
cleanup_test_env
rm -f /tmp/test_defaults.env

# Test 15: Verify no MADEINOZ_KNOWLEDGE_ prefixed variables in output
print_test "No prefixed variables in generated env"
setup_test_env "no_prefixed_vars"
GENERATED_ENV=$("$TEST_ENV_DIR/start.sh" "$TEST_ENV_DIR/.env")
if ! grep -q "MADEINOZ_KNOWLEDGE_" "$GENERATED_ENV"; then
    print_pass
else
    print_fail "Found prefixed variables in output" "test_no_prefixed"
fi
cleanup_test_env

# ============================================================================
# Summary
# ============================================================================

print_header "Test Summary"

echo "Tests Run:    $TESTS_RUN"
echo "Tests Passed: $TESTS_PASSED"
echo "Tests Failed: $TESTS_FAILED"
echo ""

if [ $TESTS_FAILED -gt 0 ]; then
    echo "Failed tests:"
    for failure in "${FAILURES[@]}"; do
        echo "  - $failure"
    done
    echo ""
    exit 1
else
    echo -e "${GREEN}All tests passed!${NC}"
    exit 0
fi
